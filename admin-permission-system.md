# 权限管理系统

## 1. 权限检测机制

### 1.1 sys过滤器（云函数层权限过滤）

框架内置了 `sys过滤器`，自动检测用户是否有执行特定云函数的权限：

```javascript
// 权限检测流程
1. 用户访问云函数 `admin/user/sys/updateUserInfo`
2. 根据token获取用户权限列表
3. 根据权限表的匹配规则校验
4. 若能匹配，放行；若不能匹配，拦截
```

### 1.2 权限匹配规则

权限系统支持多种匹配方式：

- **完整匹配**：`admin/user/sys/updateUserInfo`
- **通配符匹配**：`admin/user/sys/*`（匹配所有user模块的sys云函数）
- **正则匹配**：更复杂的权限控制需求

### 1.3 特殊角色说明

#### admin角色
- **无需赋予权限**即可访问所有云函数
- 拥有最高级别的访问权限
- 主要用于系统管理员

#### 其他角色
- 需要明确分配权限才能访问云函数
- 权限可以精确到具体的云函数URL
- 支持通配符匹配

## 2. 云函数目录规范

为了充分发挥权限过滤器的功能，建议遵循以下目录结构：

### 2.1 按端划分目录
- **admin端云函数**：`service/admin/` 目录内
- **client端云函数**：`service/client/` 目录内  
- **公共云函数**：`service/common/` 目录内

### 2.2 按权限级别划分目录
- **需要权限的云函数**：`sys` 目录内（如：`admin/user/sys/add`）
- **只需要登录的云函数**：`kh` 目录内（如：`client/user/kh/setAvatar`）
- **公开访问的云函数**：`pub` 目录内（如：`client/user/pub/login`）

**重要说明**：请求admin目录下的kh目录内的云函数（如：`admin/user/kh/setAvatar`），除了需要登录以外，登录用户的 `allow_login_background` 需为 `true`，否则也是无权限。

## 3. 权限表结构

### 3.1 权限表字段说明
```javascript
// uni-id-permissions 表结构
{
  _id: "权限ID",
  permission_id: "权限标识",     // 如: "admin/user/sys/add"
  permission_name: "权限名称",    // 如: "添加用户"
  comment: "权限说明",           // 可选
  created_date: 创建时间,
  // 其他字段...
}
```

### 3.2 角色权限关联表
```javascript
// uni-id-roles 表结构  
{
  _id: "角色ID",
  role_id: "角色标识",           // 如: "admin"
  role_name: "角色名称",         // 如: "管理员"
  permission: ["权限ID数组"],     // 关联的权限ID
  created_date: 创建时间,
  // 其他字段...
}
```

## 4. 权限管理最佳实践

### 4.1 权限分配策略
- 为每个业务模块创建对应的权限组
- 使用通配符简化权限管理（如 `admin/user/sys/*`）
- 定期审查和清理未使用的权限

### 4.2 开发建议
- 遵循统一的目录命名规范
- 在云函数注释中说明所需的权限
- 为重要的敏感操作设置独立的权限

### 4.3 测试验证
- 使用不同角色的账号测试权限控制
- 验证通配符权限的正确性
- 测试权限拒绝时的错误处理

## 5. 常见问题

### Q: 为什么我的云函数被权限系统拦截？
A: 检查云函数路径是否符合权限目录规范，确认用户角色和权限配置。

### Q: 如何快速给用户分配权限？
A: 可以通过用户管理界面批量分配权限，或者使用通配符简化权限管理。

### Q: admin角色为什么能访问所有云函数？
A: admin角色是系统内置的特殊角色，拥有最高权限，主要用于系统管理。

通过这套基于云函数URL的权限系统，可以实现精细化的访问控制，确保系统安全性和数据隔离性。